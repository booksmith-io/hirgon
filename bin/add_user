#!/usr/bin/env node

'use strict';

const { Command } = require('commander');
const bcrypt = require('bcryptjs');

const model = {
    users: require('./../models/users'),
};

const program = new Command();

program
    .version('0.001', '-v, --version', 'print the current version')
    .option('-n, --name <name>', 'name for the new user')
    .option('-e, --email <email>', 'email for the new user')
    .option('-p, --passwd <password>', 'password for the new user')
    .option('--debug', 'dump the options then exit', false);

program.parse(process.argv);
const options = program.opts();

if (!options.name || !options.passwd || !options.email) {
    program.help();
}

let hash = bcrypt.hashSync(options.passwd, 10);

if (program.debug) {
    console.log('# DEBUG:');
    console.log('name: %s', options.name);
    console.log('email: %s', options.email);
    console.log(
        'passwd and hash match: %s',
        bcrypt.compareSync(options.passwd, hash),
    );
    process.exit(0);
}

let users_obj = new model.users.Users();
const user = users_obj.get({ email: options.email });
if (user[0]) {
    console.log('a user with that email address already exists');
    process.exit(1);
}

let inserts = {
    name: options.name,
    email: options.email,
    passwd: hash,
};

users_obj.create(inserts)
    .then((ret) => {
        if (ret) {
            console.log(`user ${options.email} was added`);
            process.exit(0);
        } else {
            console.log('user was not added');
            process.exit(1);
        }
    })
    .catch((err) => {
        console.log(`error: ${err}`);
        process.exit(1);
    });

